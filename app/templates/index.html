<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title> Dublin Bikes</title>
	<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static', filename='styles/CSS.css') }}">

</head>

<body>
        
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
    
    
    function myMap() {
    	 
    	
    	
       var myLongitude = {
            lat: 53.3498,
            lng: -6.2603
        };
    
    var map = new google.maps.Map(document.getElementById("map"), {
        center: myLongitude,
        zoom: 14
    });

    google.charts.load('current', {'packages':['corechart']});
    //google.charts.setOnLoadCallback(drawChart);  
    

  
       
        //map = new google.maps.Map(mapCanvas, mapOptions);
  //  	infoWindow = new google.maps.InfoWindow;
    	// Try HTML5 geolocation.
//
  //  	if (navigator.geolocation) {
    //		navigator.geolocation.getCurrentPosition(function(position) {
    	//		var pos = {
    		//		lat: position.coords.latitude,
    			//	lng: position.coords.longitude
    		//	};
   // 			infoWindow.setPosition(pos);
    //			infoWindow.setContent('Found you!');
    	//		map.setCenter(myLongitude);
   // 		}, function() {
    //			handleLocationError(true, infoWindow, map.getCenter());
    	//	});
    //	} else {
    		// Browser doesn't support Geolocation
    	//	handleLocationError(false, infoWindow, map.getCenter());
    	//}
        
        
		mapMarkers=[];
        
		function setMarkers(view){
			
			for(i=0; i<mapMarkers.length; i++){
				mapMarkers[i].setMap(null);
			}
			mapMarkers=[];
	        
			{% for stop in stops %}
	        
	    	var name = 'Name: {{ stop[2] }} Status: {{ stop[3]}} Available bike stands: {{ stop[4]}} Available bikes: {{ stop[5] }}';
	        	
	        var infoWindow = new google.maps.InfoWindow({
	            content:  ''
	        });
	        
	        
	        if (view==0){
	        	if ({{ stop[4] }} == 0){
	        		markerColour = "red";
	        	} else if ({{ stop[4] }}/({{stop [5] }} + {{stop[4]}}) <0.9){
	        		markerColour = "orange";
	        	}else
	        		markerColour = "green";
	        }  
	        else{
	        	if ({{ stop[5] }} == 0){
	        		markerColour="red";
	        	} else if ({{ stop[5] }}/({{stop[4] }} + {{stop[5]}}) <0.9){
	        		markerColour = "orange";
	        	}else
	        		markerColour="green";
	        }
	        var marker = new google.maps.Marker({
	            position: new google.maps.LatLng({{ stop[0] }}, {{ stop[1] }}),
	        });
	        
	       marker.setIcon('http://maps.google.com/mapfiles/ms/icons/'+markerColour+'-dot.png')
	
	       marker.content= " Status: {{ stop[3]}},      Last Updated: {{stop[6]}}",
	       
			
	        
	       
	        google.maps.event.addListener(marker, 'click', function() {
	            if(!marker.open){   
	            	var data = google.visualization.arrayToDataTable([
	              	  ['Bikes', 'Data'],
	              	  ['Available bike stands', {{ stop[4]}}],
	              	  ['Available bikes', {{ stop[5] }}]
	              	]);
	              	  
	              	  var options = {'title':'{{ stop[2] }}',legend: 'value', pieSliceText: 'value', pieHole:0.4
	                          };
	
	                  var node = document.createElement('div');
	                  var html = "<div>"+
	                  "<input type='button'  value='More Information'>"+ 
	                  "</div>";
	                  infoWindow = new google.maps.InfoWindow();
	                  chart = new google.visualization.PieChart(node);
	   
	
	                  chart.draw(data, options);
	                  infoWindow.setContent(html+node.outerHTML);
	                  infoWindow.open(this.getMap(),this);
	                  marker.open = true;
	            }
	            else{
	            	infoWindow.setContent(this.content);
	            	  infoWindow.close(this.getMap(),this);
	            	marker.open = false;
	            	}
	         google.maps.event.addListener(map, 'click', function() {
	                infoWindow.close(map, marker);
	               marker.open = false;
	           });
	        });
	       
	        marker.setMap(map);
	        mapMarkers.push(marker);
	
	       
	          
	        {% endfor %}
	        document.getElementById('map').scrollIntoView();
	        }
	        myMap.setMarkers=setMarkers;
       
    }
    
    </script>
    
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>

<script type="text/javascript">
    
    if(typeof jQuery!=='undefined'){
    console.log('jQuery Loaded');
}
else{
    console.log('not loaded yet');
}
 $.getJSON("http://api.openweathermap.org/data/2.5/weather?APPID=52b3fcc8ca94382baa1747a7dde59108&q=Dublin", function(data) {
          console.log(data);  
     
     var dt = new Date();
     var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();
     var hour = dt.getHours();
     console.log(hour)
     console.log(time);
    var ktemp = data.main.temp;
     console.log(ktemp);
    var ctemp = (ktemp - 273).toFixed(2);
    var description = data.weather[0].description;
     var main = data.weather[0].main;
    var wind = data['wind'].speed
    var humidity = data.main.humidity;
    console.log(wind);
    
    
     
     var html = "";

     
        $("#wInfo").html(html);
        var tempid = $("#temp");
        tempid.html(ctemp + " &degC");
        //toggle temp unit
        var tcheck = false;
        tempid.click(function() {
          if (tcheck === false) {
            tempid.html(ktemp + " K");
            tcheck = true;
          } else {
            tempid.html(ctemp + " &degC");
            tcheck = false;
          }
        });
     
    $("<tr><td>" + data.name + ", " + data.sys.country + "</td></tr>").appendTo("#pftable");
     $("<tr><td>" + description + "</td></tr>").appendTo("#pftable");
     $("<tr><td>" + main + "</td></tr>").appendTo("#pftable");
     $("<tr><td>" + wind + " m/s" + "</td></tr>").appendTo("#pftable");
     $("<tr><td>" + humidity + "</td></tr>").appendTo("#pftable");
     
     
             if (ctemp > 25 && hour > 21) {
          $('body').css({
            'background': 'url("https://images.unsplash.com/photo-1447611636938-80e6ffe13e1e?ixlib=rb-0.3.5&q=80&fm=jpg&crop=entropy&s=2490ccef50c994d4eb847769ff4ae67f")',
            'background-size': 'cover'
          });
        } else if (ctemp < 25 && hour > 20 ) {
          $('body').css({
            'background': 'url("https://images.unsplash.com/photo-1447523264591-68112eb55c23?ixlib=rb-0.3.5&q=80&fm=jpg&crop=entropy&s=f8df825e23bd9de115150b5466f7edc6")',
            'background-size': 'cover'
              
          });

        }
             else if (ctemp < 25 && hour <11 ) {
          $('body').css({
            'background': 'url("static/Images/Bike_Rain.jpg")',
            'background-size': 'cover'
            
          });
             }
        var iconDiv = $(".icon99");

        switch (main) {
          case "Rain":
            iconDiv.toggleClass('rain');
            break;

//          case "Clouds":
//            iconDiv.toggleClass('cloud');
//            break;
          case "Clear":
            iconDiv.toggleClass('clear');
            break;
        case "Drizzle":
            iconDiv.toggleClass('rain');
            break;
          default:
            iconDiv.toggleClass('clear');
        }

 });

        
</script>
	
    <!--  https://www.w3schools.com/graphics/google_maps_basic.asp  -->
    <div class="container">
    <img class ="image" src = "{{ url_for('static',filename='Images/JustEatBikes.jpg') }}" alt="JustEat Bikes">
	    <input type="button" id="return" value="Return a bike" class="btn" onClick="myMap.setMarkers(0)" />
	    <input type="button" id="rent" value="Rent a bike" class="btn" onClick="myMap.setMarkers(1)" />
    </div> 
    
     <div id = "weather_container" class = "weatherWidget">
  <h3 class = centreFlex>Just Eat Current Weather</h3>
    
    <div id="infWrap" class = centerFlex>
        
        <div id ="icon" class="icon99"></div>
        <div id = "button"><button class="btn btn-info" id="temp"></button> </div>
    </div>
        
    <table id = "pftable">
    </table>
    
</div>
    
    <div id="map">Unable to connect, please refresh</div>
   <img id="footer" src = "{{ url_for('static',filename='Images/footer.svg') }}" alt="Footer"> 
   <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBU1JvWkSvhDQ_HuTNOfF9h7QMehuLRWmA&callback=myMap"> </script>
    </body>
</html>